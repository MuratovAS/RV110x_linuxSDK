#!/usr/bin/python3

# == BLKENVFLASH == written by Rene K. Mueller <spiritdude@gmail.com>
#
# Description:
#    Writes an image (.img) or to the SD card direct from existing .env.txt for LuckFox Pico Pro/Max
#
#       % ./blkenvflash [<images_dir>]
#       -- without -d flag, creates sdcard.img in <images_dir> --
#
#       % ./blkenvflash [<images_dir>] -d /dev/sdX
#       -- writes directly to SD card device --
#
#       -- or do in one step --
#       % sudo ./blkenvflash /dev/sdX
#
# License: MIT
#
# History:
# 2024/06/18: after the hint by A. Schuetz https://github.com/LuckfoxTECH/luckfox-pico/issues/129 was able to make script functional
# 2024/06/10: start

import os, sys, re, subprocess, shutil
import atexit

VERSION = '0.0.2'

me = sys.argv.pop(0)
path = os.path.dirname(me)
me = os.path.basename(me)

step = 'sdcard'            # -- hard-codec to do one sdcard writing

# --- parse arguments ---
images_dir = None
dev = None

args = sys.argv[:]
i = 0
while i < len(args):
   if args[i] == '-d':
      if i + 1 >= len(args):
         print(f"ERROR: -d requires a device argument")
         sys.exit(-1)
      dev = args[i + 1]
      i += 2
   elif not images_dir and not args[i].startswith('-'):
      images_dir = args[i]
      i += 1
   else:
      print(f"ERROR: unknown argument '{args[i]}'")
      sys.exit(-1)

if images_dir is None:
   images_dir = '.'

if dev is None:
   dev = os.path.join(images_dir, 'sdcard.img')

env_file = os.path.join(images_dir, '.env.txt')
if not os.path.exists(env_file):
   print(f'''USAGE: {me} [<images_dir>] [-d <device>]
   examples:
      % ./{me}                          # writes to ./sdcard.img
      % ./{me} /path/to/images          # reads images from given folder, writes to /path/to/images/sdcard.img
      % ./{me} -d /dev/sdX              # writes directly to SD card
      % ./{me} /path/to/images -d /dev/sdX

   notes:
      <images_dir>  path to folder containing .img files and .env.txt (default: current dir)
      -d <device>   block device to write to (e.g. /dev/sdX); if omitted, writes to sdcard.img
''')
   sys.exit(-1)

print(f"== {me} {VERSION} ==")
print(f"images dir: {images_dir}")
print(f"writing to: {dev}")


# -- a few helpers to en/decode nice numbers
def true_size(s):
   u = { 'B': 1, 'K': 1024, 'M': 1024*1024, 'G': 1024*1024*1024 }
   if m := re.search(r'(\d+)([BKMG])',s):
      return int(m.group(1)) * u[m.group(2)]
   return 0

def nice_size(n):
   u = { 'B': 1, 'K': 1024, 'M': 1024*1024, 'G': 1024*1024*1024 }
   for k,v in reversed(u.items()):
      if n >= v and n % v == 0:
         return f"{n//v:,}{k}"
   return f"{n:,}B"

def cleanup():
   orig = os.path.join(images_dir, '.env.txt.orig')
   if os.path.exists(orig):
      os.rename(orig, env_file)
   print("done.")

atexit.register(cleanup)

with open(env_file) as fh:
   env2 = [ ]
   for l in fh.readlines():
      if m := re.search(r'(blkdevparts)=(\w+)',l):
         _type = m.group(1)
         _dev = m.group(2)
         l = re.sub(r'blkdevparts=\w+:','',l)
         p = l.split(',')
         c_off = 0
         if step=='sdcard' and _dev == 'mmcblk1':
            for e in p:
               #print(e)
               if (m := re.search(r'(\d+[KMG])@(\d+[KMG])\((\w+)\)',e)) or (m := re.search(r'(\d+[KMG])\((\w+)\)',e)):
                  if len(m.groups())==3:
                     size = true_size(m.group(1))
                     off = true_size(m.group(2))
                     name = m.group(3)
                  else:
                     size = true_size(m.group(1))
                     name = m.group(2)
                     off = 0
                  img_path = os.path.join(images_dir, f"{name}.img")
                  print(f"   {_dev}: {name}.img size:{size:,}/{nice_size(size)} (offset:{off:,}/{nice_size(off)})",end='')
                  if os.path.exists(img_path):
                     size_ = os.path.getsize(img_path)           # -- actual size
                     print(f" imgsize:{size_:,} ({nice_size(size_)})")
                     if step=='sdcard':
                        # -- it seems the explicit `off` seems not taking effect?
                        cmd = ['dd',f"if={img_path}",f"of={dev}","bs=1k",f"seek={c_off//1024}"]
                        try:
                           res = subprocess.run(cmd,stdout=subprocess.DEVNULL,stderr=subprocess.DEVNULL,check=True)
                        except subprocess.CalledProcessError as e:
                           print(f"ERROR: {e}",e.stderr)
                           sys.exit(-1)
                     c_off += size
                  else:
                     print()
                     print(f"ERROR: '{img_path}' not found")
                     sys.exit(-1)

         if _dev == 'mmcblk0':
            env2.append(l)

if step=='emmc':           # -- untested, not needed as 'upgrade_tool' does this already
   orig = os.path.join(images_dir, '.env.txt.orig')
   shutil.copy(env_file, orig)
   with open(env_file,"w") as fh:
      fh.write("\n".join(env2))

   # -- prepare upgrade_tool call to write to eMMC
   print(f"{path}/upgrade_tool")
   subprocess.run([f'{path}/upgrade_tool','uf','update.img'])
